####
# 1. Configuration Requirements (for the DevOps setup)
#   * Configure the web server virtual host with document root on ${PROD_PROJECT_DIR}/live directory
#   * Create the ${PROD_PROJECT_DIR} directory on the target server owned by ${PROD_SSH_USER}
#   * Create the ${PROD_PROJECT_DIR}/files/default to store the public files for the project
#   * Create the ${PROD_PROJECT_DIR}/settings.local.default.php to store the default settings.php custom settings
#   * Set up the repository secrets
#       - PROD_PROJECT_DIR - Absolute path to the project root directory for the deployments (including `live` symlink)
#       - PROD_SSH_USER - SSH account to connect to the server
#       - PROD_SSH_KEY  - Private SSH key to connect to the server (public key configured on the server)
#       - PROD_SSH_HOST - SSH host IP or public hostname
# 2. Trigger manual deployment
####

on:
  workflow_dispatch:
    inputs:
      check_config:
        type: boolean
        description: 'Fail when configuration overridden'
        required: true
        default: true
      sql_backup:
        type: boolean
        description: 'Create SQL backup'
        required: true
        default: true

name: 'production instance'
jobs:
  deploy:
    name: 'deployment'
    runs-on: self-hosted
    steps:
      - name: 'Checkout source code'
        uses: actions/checkout@v2
        with:
          fetch-depth: 1

      - name: 'Install dependencies'
        uses: eaudeweb/drupal-install-action@main
        with:
          dev: false

      - name: 'Create release archive'
        id: artifact
        uses: eaudeweb/drupal-artifact-action@main

      - name: 'Deploy release on the server'
        uses: eaudeweb/drupal-deploy-action@main
        with:
          project_dir:      ${{ secrets.PROD_PROJECT_DIR }}
          release_id:       ${{ steps.artifact.outputs.base }}
          release_filename: ${{ steps.artifact.outputs.filename }}
          ssh_user:         ${{ secrets.PROD_SSH_USER }}
          ssh_host:         ${{ secrets.PROD_SSH_HOST }}
          ssh_key:          ${{ secrets.PROD_SSH_KEY }}
          check_config: ${{ github.event.inputs.check_config }}
          sql_backup: ${{ github.event.inputs.sql_backup }}

      - name: 'Update the Drupal instance'
        id: release
        uses: eaudeweb/drupal-update-action@v1
        with:
          path: ${{ secrets.PROD_PROJECT_DIR }}/live
