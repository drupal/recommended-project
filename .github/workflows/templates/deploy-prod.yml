on:
  workflow_dispatch:
    inputs:
      check_config:
        type: boolean
        description: 'Fail when configuration overridden'
        required: true
        default: true
      sql_backup:
        type: boolean
        description: 'Create SQL backup'
        required: true
        default: true
      enable_maintenance_mode:
        type: boolean
        description: 'Enable maintenance mode.'
        required: true
        default: true

name: 'Deploy PROD instance'
jobs:
  create_release_archive:
    name: 'Create release archive'
    runs-on:
      labels: 'drupal-runner-v2'
    outputs:
      release_filename: ${{ steps.artifact.outputs.filename }}
    steps:
      - name: Fail if a branch was selected
        if: github.event_name == 'workflow_dispatch' && !startsWith(github.ref, 'refs/tags/')
        run: |
          echo "This workflow should not be triggered with workflow_dispatch on a branch. Please choose a tag."
          exit 1

      - name: 'Checkout source code'
        uses: actions/checkout@v4
        with:
          fetch-depth: 1
          ref: ${{ github.event.release.tag_name }}

      # - name: 'Setup nodejs'
      #   uses: actions/setup-node@v4
      #   with:
      #     node-version-file: 'web/themes/custom/frontend/.nvmrc'

      - name: 'Install dependencies'
        uses: eaudeweb/drupal-install-action@1.x
        with:
          dev: false
      #    php: /usr/bin/php8.3

      - name: 'Create release archive'
        id: artifact
        uses: eaudeweb/drupal-artifact-action@1.x

  deploy_release:
    name: 'Deploy release on the server'
    runs-on:
      labels: 'drupal-runner-v2'
    needs: create_release_archive
    steps:
      - name: 'Deploy release on the server'
        uses: eaudeweb/drupal-deploy-action@v2.1.4
        with:
          ssh_user:             ${{ secrets.PROD_SSH_USER }}
          ssh_host:             ${{ secrets.PROD_SSH_HOST }}
          ssh_key:              ${{ secrets.PROD_SSH_KEY }}
          release_id:           'release-${{ github.ref_name }}'
          release_filename:     ${{ needs.create_release_archive.outputs.release_filename }}
          project_dir:          /var/www/html/example.org
          artifacts_dir:        /var/www/artifacts/example.org
          settings_file:        /var/www/config/example.org/settings.local.php
          public_files_dir:     /var/www/config/example.org/files
          # robo_file:          /var/www/config/example.org/robo.yml
          # database_dump_dir:  /var/www/config/example.org/sync
          check_config:         ${{ inputs.check_config }}
          sql_backup:           ${{ inputs.sql_backup }}
          # artifacts_lifespan:   30

  update_instance:
    name: 'Update Drupal instance'
    runs-on:
      labels: 'drupal-runner-v2'
    needs: deploy_release
    steps:          
      - name: 'Update the Drupal instance'
        id: release
        uses: eaudeweb/drupal-update-action@1.x
        with:
          path: /var/www/html/example.org
          enable_maintenance_mode: ${{ inputs.enable_maintenance_mode }}
      #    statuscake_api_key: ${{ secrets.STATUSCAKE_API_KEY }}
      #    statuscake_test_id: ${{ secrets.PROD_STATUSCAKE_ID }}

      - name: 'Cleanup old releases'
        uses: eaudeweb/drupal-cleanup-action@1.x
        with:
          ssh_user:             ${{ secrets.PROD_SSH_USER }}
          ssh_host:             ${{ secrets.PROD_SSH_HOST }}
          ssh_key:              ${{ secrets.PROD_SSH_KEY }}
          cleanup_dir:          /var/www/artifacts/example.org
          retain:               5

      - name: 'Discord notification'
        run: >
          curl -X POST -F "content=:white_check_mark: ${{ github.repository }} release **${{ github.ref_name }}** was
          successfully deployed on https://example.org.
          [view action run](${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }})"
          ${{ secrets.DISCORD_WEBHOOK }}

  notify_failure:
    name: 'Notify on failure'
    runs-on:
      labels: 'drupal-runner-v2'
    needs: [create_release_archive, deploy_release, update_instance]
    if: failure()
    steps:
      - name: 'Discord notification on failed deploy'
        run: >
          curl -X POST -F
          "content=:octagonal_sign: **${{ github.repository }}** release **${{ github.ref_name }}** failed to deploy on https://example.org.
          [view action run](${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }})"
          ${{ secrets.DISCORD_WEBHOOK }}
